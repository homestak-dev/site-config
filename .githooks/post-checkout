#!/bin/bash
# Auto-provision site.yaml and secrets.yaml after checkout
#
# For each file:
# 1. Do nothing if it already exists
# 2. Copy from .example template if available

cd "$(git rev-parse --show-toplevel)"

# ── site.yaml ──────────────────────────────────────────
if [ ! -f "site.yaml" ] && [ -f "site.yaml.example" ]; then
    echo "Initializing: site.yaml from site.yaml.example"
    cp "site.yaml.example" "site.yaml"
fi

# ── secrets.yaml ───────────────────────────────────────
if [ -f "secrets.yaml" ]; then
    # If .enc is newer, re-decrypt
    if [ -f "secrets.yaml.enc" ] && [ "secrets.yaml.enc" -nt "secrets.yaml" ]; then
        if [ -f ~/.config/sops/age/keys.txt ]; then
            echo "Decrypting: secrets.yaml.enc -> secrets.yaml"
            if sops -d "secrets.yaml.enc" > "secrets.yaml.tmp" 2>/dev/null; then
                mv "secrets.yaml.tmp" "secrets.yaml"
                chmod 600 "secrets.yaml"
                touch "secrets.yaml.enc"
            else
                rm -f "secrets.yaml.tmp"
                echo "Warning: Failed to decrypt secrets.yaml.enc (wrong key?)"
            fi
        fi
    fi
elif [ -f "secrets.yaml.enc" ] && [ -f ~/.config/sops/age/keys.txt ]; then
    # Try decrypting .enc file (existing users)
    echo "Decrypting: secrets.yaml.enc -> secrets.yaml"
    if sops -d "secrets.yaml.enc" > "secrets.yaml" 2>/dev/null; then
        chmod 600 "secrets.yaml"
        touch "secrets.yaml.enc"
    else
        rm -f "secrets.yaml"
        echo "Warning: Failed to decrypt secrets.yaml.enc (wrong key?)"
    fi
elif [ -f "secrets.yaml.example" ]; then
    # Fall back to example template (new users)
    echo "Initializing: secrets.yaml from secrets.yaml.example"
    cp "secrets.yaml.example" "secrets.yaml"
    chmod 600 "secrets.yaml"
fi
