#!/bin/bash
# Auto-provision secrets.yaml after checkout
#
# Priority:
# 1. Decrypt secrets.yaml.enc (existing users with age key)
# 2. Copy secrets.yaml.example (new users)
# 3. Do nothing (secrets.yaml already exists)

cd "$(git rev-parse --show-toplevel)"

# Already have plaintext secrets â€” nothing to do
if [ -f "secrets.yaml" ]; then
    # But if .enc is newer, re-decrypt
    if [ -f "secrets.yaml.enc" ] && [ "secrets.yaml.enc" -nt "secrets.yaml" ]; then
        if [ -f ~/.config/sops/age/keys.txt ]; then
            echo "Decrypting: secrets.yaml.enc -> secrets.yaml"
            if sops -d "secrets.yaml.enc" > "secrets.yaml.tmp" 2>/dev/null; then
                mv "secrets.yaml.tmp" "secrets.yaml"
                chmod 600 "secrets.yaml"
                touch "secrets.yaml.enc"
            else
                rm -f "secrets.yaml.tmp"
                echo "Warning: Failed to decrypt secrets.yaml.enc (wrong key?)"
            fi
        fi
    fi
    exit 0
fi

# Try decrypting .enc file (existing users)
if [ -f "secrets.yaml.enc" ] && [ -f ~/.config/sops/age/keys.txt ]; then
    echo "Decrypting: secrets.yaml.enc -> secrets.yaml"
    if sops -d "secrets.yaml.enc" > "secrets.yaml" 2>/dev/null; then
        chmod 600 "secrets.yaml"
        touch "secrets.yaml.enc"
        exit 0
    fi
    rm -f "secrets.yaml"
    echo "Warning: Failed to decrypt secrets.yaml.enc (wrong key?)"
fi

# Fall back to example template (new users)
if [ -f "secrets.yaml.example" ]; then
    echo "Initializing: secrets.yaml from secrets.yaml.example"
    cp "secrets.yaml.example" "secrets.yaml"
    chmod 600 "secrets.yaml"
fi
