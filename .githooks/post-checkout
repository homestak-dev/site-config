#!/bin/bash
# Auto-decrypt secrets.yaml.enc after checkout

cd "$(git rev-parse --show-toplevel)"

# Check if age key exists
if [ ! -f ~/.config/sops/age/keys.txt ]; then
    echo "Warning: No age key found at ~/.config/sops/age/keys.txt"
    echo "Run 'make setup' for instructions on setting up decryption."
    exit 0
fi

# Decrypt secrets.yaml.enc if plaintext is missing or older
if [ -f "secrets.yaml.enc" ]; then
    if [ ! -f "secrets.yaml" ] || [ "secrets.yaml.enc" -nt "secrets.yaml" ]; then
        echo "Decrypting: secrets.yaml.enc -> secrets.yaml"
        if ! sops -d "secrets.yaml.enc" > "secrets.yaml" 2>/dev/null; then
            echo "Warning: Failed to decrypt secrets.yaml.enc (wrong key?)"
            rm -f "secrets.yaml"
        fi
    fi
fi
