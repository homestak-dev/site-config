#!/bin/bash
# Block plaintext secrets.yaml from being committed
# Optionally auto-encrypt if .enc workflow is active

set -e

cd "$(git rev-parse --show-toplevel)"

# Block plaintext secrets.yaml from being committed
if git diff --cached --name-only | grep -q "^secrets\.yaml$"; then
    echo "ERROR: Plaintext secrets.yaml staged for commit!"
    echo ""
    echo "This file should be gitignored. Run: git reset HEAD secrets.yaml"
    exit 1
fi

# Auto-encrypt if the .enc workflow is active (user has both sops and existing .enc)
if [ -f "secrets.yaml" ] && [ -f "secrets.yaml.enc" ] && command -v sops >/dev/null 2>&1; then
    if [ "secrets.yaml" -nt "secrets.yaml.enc" ]; then
        echo "Encrypting: secrets.yaml -> secrets.yaml.enc"
        sops -e "secrets.yaml" > "secrets.yaml.enc"
    fi
fi
